# Visualizationå®æ—¶å¯è§†åŒ–æœåŠ¡ - æ•°æ®å±•ç¤ºä¸ç”¨æˆ·äº¤äº’

## ğŸ“‹ **Visualizationæ¦‚è¿°**

### **åŠŸèƒ½å®šä½**
Visualizationæ˜¯åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿçš„å‰ç«¯å±•ç¤ºå±‚ï¼Œè´Ÿè´£ä»Brokeré›†ç¾¤æŸ¥è¯¢ç›‘æ§æ•°æ®ï¼Œæä¾›HTTP APIæ¥å£ï¼Œé€šè¿‡WebSocketå®æ—¶æ¨é€æ•°æ®åˆ°å‰ç«¯ï¼Œä¸ºç”¨æˆ·æä¾›ç›´è§‚ã€å®æ—¶ã€äº¤äº’å¼çš„ç›‘æ§æ•°æ®å¯è§†åŒ–ä½“éªŒã€‚

### **æ ¸å¿ƒç‰¹æ€§**
- **å®æ—¶æ•°æ®æŸ¥è¯¢**: ä»Brokeré›†ç¾¤è·å–å†å²å’Œå®æ—¶ç›‘æ§æ•°æ®
- **WebSocketæ¨é€**: æ¯«ç§’çº§å®æ—¶æ•°æ®æ¨é€åˆ°å‰ç«¯ç•Œé¢
- **RESTful API**: æ ‡å‡†åŒ–APIæ¥å£ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹é›†æˆ
- **æ•°æ®åˆ†æ**: èšåˆåˆ†æã€è¶‹åŠ¿åˆ†æã€å¼‚å¸¸æ£€æµ‹ç­‰åŠŸèƒ½

---

## ğŸ—ï¸ **Visualizationæ¶æ„è®¾è®¡**

### **æœåŠ¡æ¶æ„æ¦‚è§ˆ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VisualizationæœåŠ¡æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   APIæœåŠ¡å±‚     â”‚   æ•°æ®æŸ¥è¯¢å±‚    â”‚   å®æ—¶æ¨é€å±‚    â”‚   åˆ†æå¤„ç†å±‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ HTTPæœåŠ¡å™¨    â”‚ â€¢ gRPCå®¢æˆ·ç«¯    â”‚ â€¢ WebSocket     â”‚ â€¢ æ•°æ®èšåˆ    â”‚
â”‚ â€¢ è·¯ç”±ç®¡ç†      â”‚ â€¢ å¤šBrokerè¿æ¥  â”‚ â€¢ å®æ—¶æ¨é€      â”‚ â€¢ è¶‹åŠ¿åˆ†æ    â”‚
â”‚ â€¢ ä¸­é—´ä»¶        â”‚ â€¢ è´Ÿè½½å‡è¡¡      â”‚ â€¢ è¿æ¥ç®¡ç†      â”‚ â€¢ å¼‚å¸¸æ£€æµ‹    â”‚
â”‚ â€¢ å‚æ•°éªŒè¯      â”‚ â€¢ é‡è¯•æœºåˆ¶      â”‚ â€¢ å¿ƒè·³æ£€æµ‹      â”‚ â€¢ Top-Kç®—æ³•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   å‰ç«¯ç•Œé¢      â”‚
                        â”‚ â€¢ å®æ—¶å›¾è¡¨      â”‚
                        â”‚ â€¢ æ•°æ®é¢æ¿      â”‚
                        â”‚ â€¢ å‘Šè­¦ç®¡ç†      â”‚
                        â”‚ â€¢ ç³»ç»ŸçŠ¶æ€      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **æ•°æ®æµå‘è®¾è®¡**

```
BrokeræŸ¥è¯¢ â†’ æ•°æ®è·å– â†’ æ ¼å¼è½¬æ¢ â†’ ç¼“å­˜å­˜å‚¨ â†’ APIå“åº”
     â†“          â†“          â†“          â†“          â†“
gRPCè°ƒç”¨    ç»“æ„åŒ–æ•°æ®    å‰ç«¯æ ¼å¼    å†…å­˜ç¼“å­˜   JSONè¿”å›
è´Ÿè½½å‡è¡¡    Goç»“æ„ä½“     JavaScript  LRUç¼“å­˜   HTTPå“åº”

              â†“
         å®æ—¶æ•°æ®æ¨é€
              â†“
WebSocketå¹¿æ’­ â†’ å®¢æˆ·ç«¯è¿æ¥ â†’ å‰ç«¯æ›´æ–° â†’ å›¾è¡¨æ¸²æŸ“
     â†“              â†“             â†“          â†“
  æ¶ˆæ¯åˆ†å‘        æµè§ˆå™¨è¿æ¥    æ•°æ®æ›´æ–°   å®æ—¶æ˜¾ç¤º
  å¹¶å‘æ¨é€        äº‹ä»¶é©±åŠ¨      çŠ¶æ€ç®¡ç†   ç”¨æˆ·ç•Œé¢
```

---

## ğŸŒ **HTTP APIæœåŠ¡**

### **APIæ¶æ„è®¾è®¡**

#### **è·¯ç”±æ³¨å†Œç®¡ç†**
```go
func (h *APIHandler) RegisterRoutes(mux *http.ServeMux) {
    // æŒ‡æ ‡æ•°æ®ç›¸å…³
    mux.HandleFunc("/api/metrics", h.handleMetrics)
    mux.HandleFunc("/api/metrics/host/", h.handleHostMetrics)
    mux.HandleFunc("/api/metrics/aggregate", h.handleAggregateMetrics)
    
    // åˆ†æç›¸å…³
    mux.HandleFunc("/api/analysis/trend", h.handleTrendAnalysis)
    mux.HandleFunc("/api/analysis/anomaly", h.handleAnomalyDetection)
    mux.HandleFunc("/api/analysis/topk", h.handleTopK)
    
    // å‘Šè­¦ç›¸å…³
    mux.HandleFunc("/api/alerts", h.handleAlerts)
    mux.HandleFunc("/api/alerts/rules", h.handleAlertRules)
    
    // ç³»ç»ŸçŠ¶æ€
    mux.HandleFunc("/api/system/status", h.handleSystemStatus)
    mux.HandleFunc("/api/system/stats", h.handleSystemStats)
}
```

#### **APIå¤„ç†å™¨æ¶æ„**
```go
type APIHandler struct {
    analyzer   *analysis.Analyzer    // æ•°æ®åˆ†æå™¨
    grpcClient *service.GRPCClient   // gRPCå®¢æˆ·ç«¯
}
```

### **æ ¸å¿ƒAPIæ¥å£**

#### **æŒ‡æ ‡æŸ¥è¯¢æ¥å£**
```
GET /api/metrics
å‚æ•°:
  - host_id: ä¸»æœºID (å¯é€‰)
  - start_time: å¼€å§‹æ—¶é—´ (ISO8601æ ¼å¼)
  - end_time: ç»“æŸæ—¶é—´ (ISO8601æ ¼å¼)
  - metrics: æŒ‡æ ‡ç±»å‹ (cpu,memory,network,disk)

å“åº”:
{
  "success": true,
  "data": [
    {
      "host_id": "host-1",
      "timestamp": 1640995200,
      "metrics": [
        {"name": "cpu_usage", "value": 75.5, "unit": "%"},
        {"name": "memory_usage", "value": 60.2, "unit": "%"}
      ]
    }
  ]
}
```

#### **ä¸»æœºæŒ‡æ ‡æ¥å£**
```
GET /api/metrics/host/{hostID}
å‚æ•°:
  - start_time: å¼€å§‹æ—¶é—´
  - end_time: ç»“æŸæ—¶é—´

åŠŸèƒ½: è·å–æŒ‡å®šä¸»æœºçš„æ‰€æœ‰æŒ‡æ ‡æ•°æ®
```

#### **èšåˆåˆ†ææ¥å£**
```
POST /api/metrics/aggregate
è¯·æ±‚ä½“:
{
  "host_id": "host-1",
  "metric": "cpu_usage",
  "agg_type": "avg",
  "start_time": "2023-01-01T00:00:00Z",
  "end_time": "2023-01-02T00:00:00Z"
}

åŠŸèƒ½: å¯¹æŒ‡å®šæ—¶é—´èŒƒå›´çš„æŒ‡æ ‡è¿›è¡Œèšåˆè®¡ç®—
```

### **æ•°æ®æŸ¥è¯¢å¤„ç†**

#### **æŸ¥è¯¢å‚æ•°å¤„ç†**
```
å‚æ•°è§£æ â†’ å‚æ•°éªŒè¯ â†’ é»˜è®¤å€¼è®¾ç½® â†’ æ—¶é—´èŒƒå›´æ£€æŸ¥ â†’ æŸ¥è¯¢æ‰§è¡Œ
    â”‚         â”‚         â”‚           â”‚             â”‚
    â–¼         â–¼         â–¼           â–¼             â–¼
URLå‚æ•°    æ ¼å¼éªŒè¯    é»˜è®¤1å°æ—¶     åˆç†æ€§æ£€æŸ¥     gRPCè°ƒç”¨
è§£æ       ç±»å‹æ£€æŸ¥    å½“å‰æ—¶é—´      èŒƒå›´é™åˆ¶       BrokeræŸ¥è¯¢
```

#### **æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**
- **å‚æ•°ç¼“å­˜**: ç›¸åŒæŸ¥è¯¢å‚æ•°ç»“æœç¼“å­˜ï¼Œæé«˜å“åº”é€Ÿåº¦
- **æ‰¹é‡æŸ¥è¯¢**: å¤šä¸»æœºæŸ¥è¯¢åˆå¹¶å¤„ç†ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
- **å¼‚æ­¥å¤„ç†**: å¤§æ•°æ®é‡æŸ¥è¯¢å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡
- **åˆ†é¡µæ”¯æŒ**: å¤§ç»“æœé›†åˆ†é¡µè¿”å›ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨

### **é”™è¯¯å¤„ç†ä¸å“åº”**

#### **ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_PARAMS",
    "message": "Invalid time format",
    "details": "Time format should be ISO8601"
  }
}
```

#### **é”™è¯¯ç±»å‹åˆ†ç±»**
- **å‚æ•°é”™è¯¯**: 400 Bad Request - å‚æ•°æ ¼å¼æˆ–å€¼é”™è¯¯
- **è®¤è¯é”™è¯¯**: 401 Unauthorized - è®¤è¯å¤±è´¥
- **æƒé™é”™è¯¯**: 403 Forbidden - æƒé™ä¸è¶³
- **èµ„æºé”™è¯¯**: 404 Not Found - èµ„æºä¸å­˜åœ¨
- **æœåŠ¡é”™è¯¯**: 500 Internal Server Error - æœåŠ¡å†…éƒ¨é”™è¯¯

---

## ğŸ“¡ **å®æ—¶æ•°æ®æ¨é€**

### **WebSocketæœåŠ¡æ¶æ„**

#### **WebSocketæœåŠ¡å™¨è®¾è®¡**
```go
type Server struct {
    config     *config.Config      // é…ç½®
    clients    map[*Client]bool    // å®¢æˆ·ç«¯è¿æ¥æ± 
    register   chan *Client        // æ³¨å†Œé€šé“
    unregister chan *Client        // æ³¨é”€é€šé“
    broadcast  chan []byte         // å¹¿æ’­é€šé“
    upgrader   websocket.Upgrader  // WebSocketå‡çº§å™¨
}
```

#### **å®¢æˆ·ç«¯è¿æ¥ç®¡ç†**
```go
type Client struct {
    server *Server           // æœåŠ¡å™¨å¼•ç”¨
    conn   *websocket.Conn   // WebSocketè¿æ¥
    send   chan []byte       // å‘é€ç¼“å†²é€šé“
    mu     sync.Mutex        // è¿æ¥é”
}
```

### **å®æ—¶æ•°æ®æ‹‰å–**

#### **å¢é‡æ•°æ®æ‹‰å–æœºåˆ¶**
```go
func pullDataFromBroker(ctx context.Context, client *service.GRPCClient, wsServer *websocket.Server) {
    ticker := time.NewTicker(2 * time.Second)  // 2ç§’æ‹‰å–å‘¨æœŸ
    lastSent := make(map[string]int64)         // æ¯ä¸ªä¸»æœºçš„æœ€åæ—¶é—´æˆ³
    
    for {
        select {
        case <-ticker.C:
            for _, hostID := range hostIDs {
                // è®¡ç®—å¢é‡æ—¶é—´çª—å£
                var start time.Time
                if ts, ok := lastSent[hostID]; ok && ts > 0 {
                    start = time.Unix(ts+1, 0)  // é¿å…é‡å¤æ•°æ®
                } else {
                    start = time.Now().Add(-30 * time.Second)
                }
                
                // æ‹‰å–å¢é‡æ•°æ®
                metrics, err := client.GetMetricsWithRetry(ctx, hostID, start, time.Now())
                if err == nil {
                    // å¹¿æ’­åˆ°æ‰€æœ‰WebSocketè¿æ¥
                    for _, data := range metrics {
                        wsServer.Broadcast(data)
                        lastSent[hostID] = data.Timestamp.Unix()
                    }
                }
            }
        }
    }
}
```

#### **æ•°æ®å»é‡ç­–ç•¥**
- **æ—¶é—´æˆ³ç®¡ç†**: è®°å½•æ¯ä¸ªä¸»æœºæœ€åå‘é€çš„æ•°æ®æ—¶é—´æˆ³
- **å¢é‡æ‹‰å–**: åªæ‹‰å–ä¸Šæ¬¡æ—¶é—´æˆ³ä¹‹åçš„æ–°æ•°æ®
- **å…œåº•æœºåˆ¶**: æ— å¢é‡æ•°æ®æ—¶æ‰©å¤§æ—¶é—´çª—å£é‡æ–°æ‹‰å–
- **é‡å¤æ£€æµ‹**: æ£€æµ‹é‡å¤æ•°æ®ç‚¹ï¼Œé¿å…é‡å¤æ¨é€

### **æ¶ˆæ¯å¹¿æ’­æœºåˆ¶**

#### **æ•°æ®æ ¼å¼è½¬æ¢**
```go
func (s *Server) Broadcast(data *models.MetricsData) {
    // 1. æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆå…¼å®¹å‰ç«¯ï¼‰
    var convertedMetrics []map[string]interface{}
    for _, metric := range data.Metrics {
        // æŒ‡æ ‡åç§°æ˜ å°„
        var frontendName string
        switch {
        case strings.Contains(strings.ToLower(metric.Name), "cpu"):
            frontendName = "cpu_usage"
        case strings.Contains(strings.ToLower(metric.Name), "memory"):
            frontendName = "memory_usage"
        default:
            frontendName = metric.Name
        }

        convertedMetrics = append(convertedMetrics, map[string]interface{}{
            "name":  frontendName,
            "value": metric.Value,
            "unit":  metric.Unit,
        })
    }

    // 2. æ„é€ å¹¿æ’­æ¶ˆæ¯
    message := map[string]interface{}{
        "type":      "metrics_update",
        "host_id":   data.HostID,
        "timestamp": data.Timestamp.Unix(),
        "metrics":   convertedMetrics,
    }

    // 3. JSONåºåˆ—åŒ–å¹¶å¹¿æ’­
    jsonData, _ := json.Marshal(message)
    s.broadcast <- jsonData
}
```

#### **è¿æ¥çŠ¶æ€ç®¡ç†**
```
å®¢æˆ·ç«¯è¿æ¥ â†’ æ³¨å†Œç®¡ç† â†’ å¿ƒè·³æ£€æµ‹ â†’ æ¶ˆæ¯åˆ†å‘ â†’ è¿æ¥æ¸…ç†
    â”‚           â”‚         â”‚         â”‚         â”‚
    â–¼           â–¼         â–¼         â–¼         â–¼
WebSocket     è¿æ¥æ±      å®šæœŸping   æ¶ˆæ¯æ¨é€   èµ„æºå›æ”¶
æ¡æ‰‹æˆåŠŸ      æ·»åŠ è¿æ¥   ä¿æŒæ´»è·ƒ   å¹¶å‘å‘é€   å…³é—­è¿æ¥
```

### **è¿æ¥ä¼˜åŒ–ä¸å®¹é”™**

#### **å¿ƒè·³æœºåˆ¶**
- **Pingé—´éš”**: 30ç§’å‘é€Pingæ¶ˆæ¯æ£€æµ‹è¿æ¥çŠ¶æ€
- **Pongè¶…æ—¶**: 60ç§’æœªæ”¶åˆ°Pongå“åº”åˆ™å…³é—­è¿æ¥
- **è‡ªåŠ¨é‡è¿**: å®¢æˆ·ç«¯æ£€æµ‹åˆ°è¿æ¥æ–­å¼€è‡ªåŠ¨é‡æ–°è¿æ¥
- **è¿æ¥æ± æ¸…ç†**: å®šæœŸæ¸…ç†åƒµå°¸è¿æ¥ï¼Œé‡Šæ”¾èµ„æº

#### **èƒŒå‹æ§åˆ¶**
- **å‘é€ç¼“å†²**: æ¯ä¸ªè¿æ¥è®¾ç½®å‘é€ç¼“å†²åŒºï¼Œé¿å…é˜»å¡
- **æ…¢æ¶ˆè´¹è€…**: æ£€æµ‹æ…¢æ¶ˆè´¹è€…ï¼Œå¿…è¦æ—¶ä¸»åŠ¨æ–­å¼€è¿æ¥
- **å†…å­˜æ§åˆ¶**: é™åˆ¶æ€»è¿æ¥æ•°å’Œç¼“å†²åŒºå¤§å°ï¼Œé˜²æ­¢OOM
- **ä¼˜é›…é™çº§**: é«˜è´Ÿè½½æ—¶é™ä½æ¨é€é¢‘ç‡æˆ–æ•°æ®ç²¾åº¦

---

## ğŸ“Š **æ•°æ®åˆ†æä¸èšåˆ**

### **åˆ†æå™¨æ¶æ„**

#### **åˆ†æå™¨è®¾è®¡**
```go
type Analyzer struct {
    dataCache   map[string][]*models.MetricsData  // æ•°æ®ç¼“å­˜
    aggregators map[string]Aggregator              // èšåˆå™¨æ˜ å°„
    cacheMutex  sync.RWMutex                      // ç¼“å­˜é”
    config      *AnalysisConfig                   // åˆ†æé…ç½®
}
```

#### **èšåˆå™¨æ¥å£**
```go
type Aggregator interface {
    Aggregate(data []*models.MetricsData, timeRange TimeRange) (*AggregationResult, error)
    GetType() string
    GetName() string
}
```

### **èšåˆåˆ†æåŠŸèƒ½**

#### **åŸºç¡€èšåˆè®¡ç®—**
- **å¹³å‡å€¼**: è®¡ç®—æŒ‡å®šæ—¶é—´èŒƒå›´å†…æŒ‡æ ‡çš„å¹³å‡å€¼
- **æœ€å¤§å€¼**: è·å–æ—¶é—´èŒƒå›´å†…çš„æœ€å¤§æŒ‡æ ‡å€¼
- **æœ€å°å€¼**: è·å–æ—¶é—´èŒƒå›´å†…çš„æœ€å°æŒ‡æ ‡å€¼
- **æ€»å’Œ**: ç´¯è®¡æŒ‡æ ‡å€¼æ€»å’Œï¼ˆé€‚ç”¨äºæµé‡ç­‰ï¼‰
- **è®¡æ•°**: ç»Ÿè®¡æ•°æ®ç‚¹æ•°é‡

#### **èšåˆè®¡ç®—æµç¨‹**
```
æ•°æ®è¾“å…¥ â†’ æ—¶é—´è¿‡æ»¤ â†’ æŒ‡æ ‡åˆ†ç»„ â†’ èšåˆè®¡ç®— â†’ ç»“æœæ ¼å¼åŒ–
    â”‚         â”‚         â”‚         â”‚           â”‚
    â–¼         â–¼         â–¼         â–¼           â–¼
åŸå§‹æ•°æ®   æ—¶é—´èŒƒå›´   æŒ‰æŒ‡æ ‡åˆ†ç±»   ç»Ÿè®¡å‡½æ•°    ç»“æ„åŒ–ç»“æœ
å¤šä¸ªæ•°æ®ç‚¹  è¿‡æ»¤å™¨    åˆ†ç»„Map     æ•°å­¦è®¡ç®—    JSONæ ¼å¼
```

### **è¶‹åŠ¿åˆ†æ**

#### **è¶‹åŠ¿è®¡ç®—ç®—æ³•**
```go
func (a *Analyzer) CalculateTrend(data []*models.MetricsData, metric string) (*TrendResult, error) {
    // 1. æ•°æ®é¢„å¤„ç†
    values := extractMetricValues(data, metric)
    timestamps := extractTimestamps(data)
    
    // 2. çº¿æ€§å›å½’è®¡ç®—
    slope, intercept := linearRegression(timestamps, values)
    
    // 3. è¶‹åŠ¿åˆ¤æ–­
    trend := "stable"
    if slope > 0.1 {
        trend = "increasing"
    } else if slope < -0.1 {
        trend = "decreasing"
    }
    
    return &TrendResult{
        Metric:    metric,
        Trend:     trend,
        Slope:     slope,
        Intercept: intercept,
    }, nil
}
```

#### **è¶‹åŠ¿åˆ†æç±»å‹**
- **ä¸Šå‡è¶‹åŠ¿**: æŒ‡æ ‡å€¼å‘ˆç°æŒç»­ä¸Šå‡æ€åŠ¿
- **ä¸‹é™è¶‹åŠ¿**: æŒ‡æ ‡å€¼å‘ˆç°æŒç»­ä¸‹é™æ€åŠ¿
- **ç¨³å®šè¶‹åŠ¿**: æŒ‡æ ‡å€¼åœ¨åˆç†èŒƒå›´å†…æ³¢åŠ¨
- **å‘¨æœŸæ€§è¶‹åŠ¿**: æŒ‡æ ‡å€¼å‘ˆç°å‘¨æœŸæ€§å˜åŒ–æ¨¡å¼

### **å¼‚å¸¸æ£€æµ‹**

#### **å¼‚å¸¸æ£€æµ‹ç®—æ³•**
- **ç»Ÿè®¡å¼‚å¸¸**: åŸºäºå‡å€¼å’Œæ ‡å‡†å·®çš„2Ïƒ/3Ïƒå‡†åˆ™
- **é˜ˆå€¼å¼‚å¸¸**: è¶…è¿‡é¢„è®¾é˜ˆå€¼çš„å¼‚å¸¸å€¼æ£€æµ‹
- **è¶‹åŠ¿å¼‚å¸¸**: æŒ‡æ ‡å˜åŒ–è¶‹åŠ¿çš„å¼‚å¸¸æ£€æµ‹
- **å‘¨æœŸå¼‚å¸¸**: ç›¸å¯¹äºå†å²åŒæœŸçš„å¼‚å¸¸æ£€æµ‹

#### **å¼‚å¸¸æ£€æµ‹æµç¨‹**
```
å†å²æ•°æ® â†’ åŸºçº¿è®¡ç®— â†’ å®æ—¶æ¯”è¾ƒ â†’ å¼‚å¸¸åˆ¤å®š â†’ å¼‚å¸¸æ ‡è®°
    â”‚         â”‚         â”‚         â”‚         â”‚
    â–¼         â–¼         â–¼         â–¼         â–¼
è¿‡å»30å¤©   ç»Ÿè®¡åŸºçº¿   å½“å‰æ•°å€¼   é˜ˆå€¼æ¯”è¾ƒ   å¼‚å¸¸çº§åˆ«
ç»Ÿè®¡åˆ†æ   å‡å€¼/æ ‡å‡†å·®  å®æ—¶æ•°æ®   åå·®è®¡ç®—   å‘Šè­¦ç­‰çº§
```

---

## ğŸ” **gRPCå®¢æˆ·ç«¯æœåŠ¡**

### **å®¢æˆ·ç«¯è¿æ¥ç®¡ç†**

#### **å¤šBrokerè¿æ¥**
```go
type GRPCClient struct {
    config     *config.Config
    conns      map[string]*grpc.ClientConn        // Brokerè¿æ¥æ± 
    clients    map[string]pb.MonitorServiceClient // å®¢æˆ·ç«¯æ± 
    mu         sync.RWMutex                       // è¯»å†™é”
    retryCount int                                // é‡è¯•æ¬¡æ•°
}
```

#### **è´Ÿè½½å‡è¡¡ç­–ç•¥**
- **è½®è¯¢ç®—æ³•**: ä¾æ¬¡é€‰æ‹©ä¸åŒçš„BrokerèŠ‚ç‚¹
- **å¥åº·æ£€æŸ¥**: åªé€‰æ‹©å¥åº·çš„BrokerèŠ‚ç‚¹
- **æ•…éšœåˆ‡æ¢**: èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–èŠ‚ç‚¹
- **æƒé‡åˆ†é…**: æ ¹æ®èŠ‚ç‚¹æ€§èƒ½åˆ†é…ä¸åŒæƒé‡

### **æŸ¥è¯¢è¯·æ±‚å¤„ç†**

#### **å¸¦é‡è¯•çš„æŸ¥è¯¢æœºåˆ¶**
```go
func (c *GRPCClient) GetMetricsWithRetry(ctx context.Context, hostID string, start, end time.Time) ([]*models.MetricsData, error) {
    for i := 0; i <= c.retryCount; i++ {
        result, err := c.GetMetrics(ctx, hostID, start, end)
        if err == nil {
            return result, nil
        }
        
        // å¤±è´¥åˆ™åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªBroker
        c.nextBroker()
        
        // ç­‰å¾…åé‡è¯•
        if i < c.retryCount {
            time.Sleep(time.Duration(i+1) * time.Second)
        }
    }
    return nil, fmt.Errorf("all brokers failed after %d retries", c.retryCount)
}
```

#### **æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**
- **è¿æ¥å¤ç”¨**: å¤ç”¨gRPCè¿æ¥ï¼Œå‡å°‘å»ºè¿å¼€é”€
- **å¹¶å‘æŸ¥è¯¢**: å¤šä¸»æœºæŸ¥è¯¢å¹¶å‘æ‰§è¡Œï¼Œæé«˜æ•ˆç‡
- **ç»“æœç¼“å­˜**: çƒ­ç‚¹æŸ¥è¯¢ç»“æœç¼“å­˜ï¼Œå‡å°‘é‡å¤æŸ¥è¯¢
- **è¶…æ—¶æ§åˆ¶**: è®¾ç½®åˆç†çš„æŸ¥è¯¢è¶…æ—¶æ—¶é—´

### **æ•°æ®æ ¼å¼è½¬æ¢**

#### **Protobufåˆ°Goç»“æ„è½¬æ¢**
```go
func convertProtoToModel(data *pb.MetricsData) *models.MetricsData {
    metrics := make([]models.Metric, 0, len(data.Metrics))
    for _, m := range data.Metrics {
        value, err := strconv.ParseFloat(m.Value, 64)
        if err != nil {
            continue // è·³è¿‡æ— æ•ˆæ•°å€¼
        }
        metrics = append(metrics, models.Metric{
            Name:  m.Name,
            Value: value,
            Unit:  m.Unit,
        })
    }

    return &models.MetricsData{
        HostID:    data.HostId,
        Timestamp: time.Unix(data.Timestamp, 0),
        Metrics:   metrics,
    }
}
```

Visualizationä½œä¸ºåˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿçš„ç”¨æˆ·æ¥å£å±‚ï¼Œé€šè¿‡é«˜æ•ˆçš„æ•°æ®æŸ¥è¯¢ã€å®æ—¶çš„WebSocketæ¨é€å’Œå‹å¥½çš„Webç•Œé¢ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¼˜ç§€çš„ç›‘æ§æ•°æ®å¯è§†åŒ–ä½“éªŒï¼Œæ˜¯æ•´ä¸ªç›‘æ§ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚
