<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分布式实时监控系统</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        header h1 {
            margin: 0;
            padding: 0 20px;
            font-size: 24px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .metrics {
            margin-bottom: 10px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .metric-name {
            font-weight: bold;
        }
        .metric-value {
            color: #2980b9;
        }
        .status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online {
            background-color: #2ecc71;
            color: white;
        }
        .status-offline {
            background-color: #e74c3c;
            color: white;
        }
        .status-warning {
            background-color: #f39c12;
            color: white;
        }
        .log-container {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 5px;
        }
        .timestamp {
            color: #95a5a6;
            margin-right: 10px;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        select {
            padding: 8px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>分布式实时监控系统</h1>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <button id="connect-btn">连接WebSocket</button>
            <button id="disconnect-btn" disabled>断开连接</button>
            <select id="host-select">
                <option value="host-1">主机1</option>
                <option value="host-2">主机2</option>
                <option value="host-3">主机3</option>
            </select>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>CPU <span class="status status-online">在线</span></h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-name">使用率</span>
                        <span class="metric-value" id="cpu-usage">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">温度</span>
                        <span class="metric-value" id="cpu-temp">0°C</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">负载(1分钟)</span>
                        <span class="metric-value" id="cpu-load-1">0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">负载(5分钟)</span>
                        <span class="metric-value" id="cpu-load-5">0.00</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">负载(15分钟)</span>
                        <span class="metric-value" id="cpu-load-15">0.00</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>内存 <span class="status status-online">在线</span></h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-name">总内存</span>
                        <span class="metric-value" id="mem-total">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">已使用</span>
                        <span class="metric-value" id="mem-used">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">空闲</span>
                        <span class="metric-value" id="mem-free">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">使用率</span>
                        <span class="metric-value" id="mem-usage">0%</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>网络 <span class="status status-online">在线</span></h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-name">接收速率</span>
                        <span class="metric-value" id="net-rx">0 KB/s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">发送速率</span>
                        <span class="metric-value" id="net-tx">0 KB/s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">TCP连接数</span>
                        <span class="metric-value" id="net-tcp">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>磁盘 <span class="status status-online">在线</span></h2>
                <div class="metrics">
                    <div class="metric">
                        <span class="metric-name">总空间</span>
                        <span class="metric-value" id="disk-total">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">已使用</span>
                        <span class="metric-value" id="disk-used">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">空闲</span>
                        <span class="metric-value" id="disk-free">0 GB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">使用率</span>
                        <span class="metric-value" id="disk-usage">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">读取速率</span>
                        <span class="metric-value" id="disk-read">0 KB/s</span>
                    </div>
                    <div class="metric">
                        <span class="metric-name">写入速率</span>
                        <span class="metric-value" id="disk-write">0 KB/s</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>系统日志</h2>
            <div class="log-container" id="log-container">
                <div class="log-entry">
                    <span class="timestamp">2023-06-01 12:00:00</span>
                    <span class="log-message">系统启动</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const hostSelect = document.getElementById('host-select');
        const logContainer = document.getElementById('log-container');

        function addLogEntry(message) {
            const now = new Date();
            const timestamp = now.toLocaleString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span><span class="log-message">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
            }

            const host = window.location.host;
            ws = new WebSocket(`ws://${host}/ws`);

            ws.onopen = function() {
                addLogEntry('WebSocket连接已建立');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            };

            ws.onclose = function() {
                addLogEntry('WebSocket连接已关闭');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                ws = null;
            };

            ws.onerror = function(error) {
                addLogEntry(`WebSocket错误: ${error}`);
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateMetrics(data);
                    addLogEntry(`收到来自 ${data.host_id} 的数据`);
                } catch (e) {
                    addLogEntry(`解析数据失败: ${e.message}`);
                }
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }

        function updateMetrics(data) {
            // 更新指标显示
            if (data.host_id !== hostSelect.value) {
                return;
            }

            for (const metric of data.metrics) {
                switch (metric.name) {
                    case 'cpu.usage':
                        document.getElementById('cpu-usage').textContent = `${metric.value.toFixed(2)}%`;
                        break;
                    case 'cpu.temperature':
                        document.getElementById('cpu-temp').textContent = `${metric.value.toFixed(1)}°C`;
                        break;
                    case 'cpu.load_avg_1':
                        document.getElementById('cpu-load-1').textContent = metric.value.toFixed(2);
                        break;
                    case 'cpu.load_avg_5':
                        document.getElementById('cpu-load-5').textContent = metric.value.toFixed(2);
                        break;
                    case 'cpu.load_avg_15':
                        document.getElementById('cpu-load-15').textContent = metric.value.toFixed(2);
                        break;
                    case 'memory.total':
                        document.getElementById('mem-total').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'memory.used':
                        document.getElementById('mem-used').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'memory.free':
                        document.getElementById('mem-free').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'memory.usage':
                        document.getElementById('mem-usage').textContent = `${metric.value.toFixed(2)}%`;
                        break;
                    case 'network.rx_bytes_rate':
                        document.getElementById('net-rx').textContent = `${(metric.value / 1024).toFixed(2)} KB/s`;
                        break;
                    case 'network.tx_bytes_rate':
                        document.getElementById('net-tx').textContent = `${(metric.value / 1024).toFixed(2)} KB/s`;
                        break;
                    case 'network.tcp_connections':
                        document.getElementById('net-tcp').textContent = metric.value;
                        break;
                    case 'disk.total':
                        document.getElementById('disk-total').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'disk.used':
                        document.getElementById('disk-used').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'disk.free':
                        document.getElementById('disk-free').textContent = `${(metric.value / (1024 * 1024 * 1024)).toFixed(2)} GB`;
                        break;
                    case 'disk.usage_rate':
                        document.getElementById('disk-usage').textContent = `${metric.value.toFixed(2)}%`;
                        break;
                    case 'disk.read_bytes':
                        document.getElementById('disk-read').textContent = `${(metric.value / 1024).toFixed(2)} KB/s`;
                        break;
                    case 'disk.write_bytes':
                        document.getElementById('disk-write').textContent = `${(metric.value / 1024).toFixed(2)} KB/s`;
                        break;
                }
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            connectBtn.addEventListener('click', connectWebSocket);
            disconnectBtn.addEventListener('click', disconnectWebSocket);
            hostSelect.addEventListener('change', function() {
                addLogEntry(`切换到主机: ${hostSelect.value}`);
            });

            // 检查系统状态
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    addLogEntry(`系统状态: ${data.status}, 版本: ${data.version}`);
                })
                .catch(error => {
                    addLogEntry(`获取系统状态失败: ${error.message}`);
                });
        });
    </script>
</body>
</html> 